name: Agentic QE - Test Execution

on:
  workflow_dispatch:
    inputs:
      test_ids:
        description: 'Comma-separated test case IDs'
        required: true
        type: string
      triggered_by:
        description: 'Who triggered this execution'
        required: false
        default: 'manual'
        type: string

jobs:
  execute-tests:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.16.0'
          cache: 'npm'
      
      - name: Install dependencies
        shell: powershell
        run: |
          Write-Host "Checking for package-lock.json..."
          if (Test-Path "package-lock.json") {
            Write-Host "Found package-lock.json, using npm ci"
            npm ci --legacy-peer-deps
          } else {
            Write-Host "No package-lock.json found, using npm install"
            npm install --legacy-peer-deps
          }
      
      - name: Install Playwright
        shell: powershell
        run: |
          $playwrightInstalled = npm list @playwright/test 2>$null
          if (-not $playwrightInstalled) {
            Write-Host "Installing Playwright..."
            npm install --save-dev @playwright/test --legacy-peer-deps
          } else {
            Write-Host "Playwright already installed"
          }
          # Install TypeScript support if needed
          $tsInstalled = npm list typescript 2>$null
          if (-not $tsInstalled) {
            Write-Host "Installing TypeScript..."
            npm install --save-dev typescript @types/node --legacy-peer-deps
          }
          # Install ts-node or @swc/core for TypeScript config compilation
          $tsNodeInstalled = npm list ts-node 2>$null
          $swcInstalled = npm list @swc/core 2>$null
          if (-not $tsNodeInstalled -and -not $swcInstalled) {
            Write-Host "Installing ts-node for TypeScript config support..."
            try {
              npm install --save-dev ts-node --legacy-peer-deps
            } catch {
              npm install --save-dev @swc/core @swc/helpers --legacy-peer-deps
            }
          }
          Write-Host "Installing Playwright browsers..."
          npx playwright install --with-deps
      
      - name: Create Playwright config if missing
        shell: powershell
        run: |
          $configExists = (Test-Path "playwright.config.ts") -or (Test-Path "playwright.config.js") -or (Test-Path "playwright.config.mjs")
          if (-not $configExists) {
            Write-Host "Creating basic Playwright config (TypeScript format)..."
            $configContent = @"
          import { defineConfig, devices } from '@playwright/test';

          /**
           * See https://playwright.dev/docs/test-configuration.
           */
          export default defineConfig({
            testDir: './src/tests',
            /* Run tests in files in parallel */
            fullyParallel: true,
            /* Fail the build on CI if you accidentally left test.only in the source code. */
            forbidOnly: !!process.env.CI,
            /* Retry on CI only */
            retries: process.env.CI ? 2 : 0,
            /* Opt out of parallel tests on CI. */
            workers: process.env.CI ? 1 : undefined,
            /* Reporter to use. See https://playwright.dev/docs/test-reporters */
            reporter: 'html',
            /* Shared settings for all the projects below. See https://playwright.dev/docs/api/class-testoptions. */
            use: {
              /* Base URL to use in actions like `await page.goto('/')`. */
              // baseURL: 'http://127.0.0.1:3000',

              /* Collect trace when retrying the failed test. See https://playwright.dev/docs/trace-viewer */
              trace: 'on-first-retry',
            },

            /* Configure projects for major browsers */
            projects: [
              {
                name: 'chromium',
                use: { ...devices['Desktop Chrome'] },
              },

              // {
              //   name: 'firefox',
              //   use: { ...devices['Desktop Firefox'] },
              // },

              // {
              //   name: 'webkit',
              //   use: { ...devices['Desktop Safari'] },
              // },
            ],
          });
          "@
            Set-Content -Path "playwright.config.ts" -Value $configContent
            Write-Host "Created playwright.config.ts"
          } else {
            Write-Host "Playwright config already exists"
          }
      
      - name: Run Playwright tests
        shell: powershell
        run: |
          Write-Host "Running Playwright tests: ${{ inputs.test_ids }}"
          Write-Host "Current directory: $(Get-Location)"
          
          # Check if tests directory exists
          if (-not (Test-Path "src/tests")) {
            Write-Host "Tests directory not found. Creating it..."
            New-Item -ItemType Directory -Path "src/tests" -Force | Out-Null
          }
          
          # List all files in tests directory for debugging
          Write-Host ""
          Write-Host "Files in tests directory:"
          if (Test-Path "src/tests") {
            $allFiles = Get-ChildItem -Path "src/tests" -Recurse -File | Select-Object FullName
            if ($allFiles) {
              foreach ($file in $allFiles) {
                Write-Host "   - $($file.FullName)"
              }
            } else {
              Write-Host "   (no files found)"
            }
          } else {
            Write-Host "   (directory doesn't exist)"
          }
          Write-Host ""
          
          $testIds = "${{ inputs.test_ids }}".Split(',')
          $exitCode = 0
          $testsFound = 0
          
          foreach ($testId in $testIds) {
            $testId = $testId.Trim()
            Write-Host "Executing test: $testId"
            
            # Find test file matching the test ID
            # Search for each pattern separately since -Include can be finicky
            $testFile = $null
            $patterns = @("*$testId*.spec.ts", "*$testId*.spec.js", "*$testId*.spec.mjs")
            
            # Also try without .spec extension
            $patterns += @("*$testId*.ts", "*$testId*.js")
            
            foreach ($pattern in $patterns) {
              if (-not $testFile) {
                $found = Get-ChildItem -Path "src/tests" -Recurse -Filter $pattern -ErrorAction SilentlyContinue | Select-Object -First 1
                if ($found) {
                  $testFile = $found
                  break
                }
              }
            }
            
            if ($testFile) {
              Write-Host "Found test file: $($testFile.FullName)"
              $testsFound++
              try {
                # Since Playwright config has testDir: './src/tests', 
                # we need to pass path relative to that directory or use filename
                $fileName = $testFile.Name
                $fileDir = $testFile.DirectoryName
                
                # Check if file is in src/tests directory
                if ($fileDir -like "*\src\tests*" -or $fileDir -like "*/src/tests*") {
                  # Use just the filename since testDir is already set to src/tests
                  Write-Host "File is in src/tests, using filename: $fileName"
                  npx playwright test "$fileName"
                } else {
                  # Use relative path from repo root
                  $repoRoot = (Get-Location).Path
                  $relativePath = $testFile.FullName.Replace($repoRoot, "").TrimStart("\", "/").Replace("\", "/")
                  Write-Host "Using relative path: $relativePath"
                  npx playwright test "$relativePath"
                }
                
                $testExitCode = $LASTEXITCODE
                
                if ($testExitCode -ne 0) {
                  Write-Host "Test execution returned exit code: $testExitCode"
                  $exitCode = $testExitCode
                }
              } catch {
                Write-Host "Test execution failed: $_"
                $exitCode = 1
              }
            } else {
              Write-Host "Test file not found for: $testId"
              Write-Host "   Searched for patterns: $($patterns -join ', ')"
              $exitCode = 1
            }
          }
          
          if ($testsFound -eq 0) {
            Write-Host "No test files found. Make sure your test files are in the 'src/tests' directory and named like: src/tests/XSP-16-TC01.spec.ts"
            Write-Host ""
            Write-Host "Tips:"
            Write-Host "   - Test files should be in the 'src/tests' directory"
            Write-Host "   - File names should contain the test ID (e.g., XSP-16-TC01)"
            Write-Host "   - Supported extensions: .spec.ts, .spec.js, .spec.mjs, .ts, .js"
            exit 1
          }
          
          exit $exitCode
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Publish test report
        if: always()
        shell: powershell
        run: |
          Write-Host "Test execution completed"
          Write-Host "Framework: Playwright"
          Write-Host "Test IDs: ${{ inputs.test_ids }}"
          Write-Host "Triggered by: ${{ inputs.triggered_by }}"
