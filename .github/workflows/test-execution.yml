name: Agentic QE - Test Execution

on:
  workflow_dispatch:
    inputs:
      test_ids:
        description: 'Comma-separated test case IDs'
        required: true
        type: string
      triggered_by:
        description: 'Who triggered this execution'
        required: false
        default: 'manual'
        type: string

jobs:
  execute-tests:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.16.0'
          cache: 'npm'
      
      - name: Install dependencies
        shell: pwsh
        run: |
          Write-Host "Checking for package-lock.json..."
          if (Test-Path "package-lock.json") {
            Write-Host "Found package-lock.json, using npm ci"
            npm ci --legacy-peer-deps
          } else {
            Write-Host "No package-lock.json found, using npm install"
            npm install --legacy-peer-deps
          }
      
      - name: Install Playwright
        shell: pwsh
        run: |
          $playwrightInstalled = npm list @playwright/test 2>$null
          if (-not $playwrightInstalled) {
            Write-Host "Installing Playwright..."
            npm install --save-dev @playwright/test --legacy-peer-deps
          } else {
            Write-Host "Playwright already installed"
          }
          # Install TypeScript support if needed
          $tsInstalled = npm list typescript 2>$null
          if (-not $tsInstalled) {
            Write-Host "Installing TypeScript..."
            npm install --save-dev typescript @types/node --legacy-peer-deps
          }
          # Install ts-node or @swc/core for TypeScript config compilation
          $tsNodeInstalled = npm list ts-node 2>$null
          $swcInstalled = npm list @swc/core 2>$null
          if (-not $tsNodeInstalled -and -not $swcInstalled) {
            Write-Host "Installing ts-node for TypeScript config support..."
            try {
              npm install --save-dev ts-node --legacy-peer-deps
            } catch {
              npm install --save-dev @swc/core @swc/helpers --legacy-peer-deps
            }
          }
          Write-Host "Installing Playwright browsers..."
          npx playwright install --with-deps
      
      - name: Create Playwright config if missing
        shell: pwsh
        run: |
          $configExists = (Test-Path "playwright.config.ts") -or (Test-Path "playwright.config.js") -or (Test-Path "playwright.config.mjs")
          if (-not $configExists) {
            Write-Host "Creating basic Playwright config (TypeScript format)..."
            $configContent = @"
          import { defineConfig, devices } from '@playwright/test';

          /**
           * See https://playwright.dev/docs/test-configuration.
           */
          export default defineConfig({
            testDir: './tests',
            /* Run tests in files in parallel */
            fullyParallel: true,
            /* Fail the build on CI if you accidentally left test.only in the source code. */
            forbidOnly: !!process.env.CI,
            /* Retry on CI only */
            retries: process.env.CI ? 2 : 0,
            /* Opt out of parallel tests on CI. */
            workers: process.env.CI ? 1 : undefined,
            /* Reporter to use. See https://playwright.dev/docs/test-reporters */
            reporter: 'html',
            /* Shared settings for all the projects below. See https://playwright.dev/docs/api/class-testoptions. */
            use: {
              /* Base URL to use in actions like `await page.goto('/')`. */
              // baseURL: 'http://127.0.0.1:3000',

              /* Collect trace when retrying the failed test. See https://playwright.dev/docs/trace-viewer */
              trace: 'on-first-retry',
            },

            /* Configure projects for major browsers */
            projects: [
              {
                name: 'chromium',
                use: { ...devices['Desktop Chrome'] },
              },

              // {
              //   name: 'firefox',
              //   use: { ...devices['Desktop Firefox'] },
              // },

              // {
              //   name: 'webkit',
              //   use: { ...devices['Desktop Safari'] },
              // },
            ],
          });
          "@
            Set-Content -Path "playwright.config.ts" -Value $configContent
            Write-Host "✅ Created playwright.config.ts"
          } else {
            Write-Host "✅ Playwright config already exists"
          }
      
      - name: Run Playwright tests
        shell: pwsh
        run: |
          Write-Host "Running Playwright tests: ${{ inputs.test_ids }}"
          
          $testIds = "${{ inputs.test_ids }}".Split(',')
          $exitCode = 0
          $testsFound = 0
          
          foreach ($testId in $testIds) {
            $testId = $testId.Trim()
            Write-Host "Executing test: $testId"
            
            # Find test file matching the test ID
            $testFile = Get-ChildItem -Path "tests" -Recurse -Filter "*$testId*.spec.ts","*$testId*.spec.js","*$testId*.spec.mjs" -ErrorAction SilentlyContinue | Select-Object -First 1
            
            if ($testFile) {
              Write-Host "Found test file: $($testFile.FullName)"
              $testsFound++
              try {
                npx playwright test $testFile.FullName
                if ($LASTEXITCODE -ne 0) {
                  $exitCode = $LASTEXITCODE
                }
              } catch {
                Write-Host "Test execution failed: $_"
                $exitCode = 1
              }
            } else {
              Write-Host "⚠️ Test file not found for: $testId"
              $exitCode = 1
            }
          }
          
          if ($testsFound -eq 0) {
            Write-Host "⚠️ No test files found. Make sure your test files are in the 'tests' directory and named like: tests/XSP-16-TC01.spec.ts"
            exit 1
          }
          
          exit $exitCode
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Publish test report
        if: always()
        shell: pwsh
        run: |
          Write-Host "Test execution completed"
          Write-Host "Framework: Playwright"
          Write-Host "Test IDs: ${{ inputs.test_ids }}"
          Write-Host "Triggered by: ${{ inputs.triggered_by }}"
